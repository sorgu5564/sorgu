<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>A101 Stok Sorgulama</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f2f2f2; padding:20px }
.box { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:8px }
input, button { width:100%; padding:10px; margin-top:10px; font-size:16px }
button:disabled { background:#ccc }
table { width:100%; border-collapse:collapse; margin-top:20px }
th, td { border:1px solid #ccc; padding:8px }
th { background:#eee }
.sufficient { color:green; font-weight:bold }
.limited { color:orange; font-weight:bold }
.out { color:red; font-weight:bold }
.info { margin-top:10px; font-style:italic }
</style>
</head>
<body>

<div class="box">
<h2>A101 Stok Sorgu</h2>

<label>Ürün (Item ID)</label>
<input id="itemId" value="30000905">

<button id="btn" onclick="baslat()">Sorgula</button>

<div id="info" class="info"></div>
<div id="tablo"></div>
</div>

<script>
const HEDEF_GEOHASH = "sxkc1x5gj";
const MAKS_MESAFE = 200; // metre
let kilitli = false;

/* ---------------- GEOHASH DECODE ---------------- */
const base32 = "0123456789bcdefghjkmnpqrstuvwxyz";

function decodeGeohash(geohash) {
    let even = true;
    let lat = [-90, 90];
    let lon = [-180, 180];

    for (let c of geohash) {
        let bits = base32.indexOf(c);
        for (let i = 4; i >= 0; i--) {
            let mid;
            if (even) {
                mid = (lon[0] + lon[1]) / 2;
                (bits >> i) & 1 ? lon[0] = mid : lon[1] = mid;
            } else {
                mid = (lat[0] + lat[1]) / 2;
                (bits >> i) & 1 ? lat[0] = mid : lat[1] = mid;
            }
            even = !even;
        }
    }
    return {
        lat: (lat[0] + lat[1]) / 2,
        lng: (lon[0] + lon[1]) / 2
    };
}

/* ---------------- MESAFE HESABI ---------------- */
function mesafeMetre(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ---------------- ANA AKIŞ ---------------- */
function baslat() {
    if (!navigator.geolocation) {
        alert("Konum desteklenmiyor");
        return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
        const userLat = pos.coords.latitude;
        const userLng = pos.coords.longitude;

        const hedef = decodeGeohash(HEDEF_GEOHASH);
        const mesafe = mesafeMetre(
            userLat, userLng,
            hedef.lat, hedef.lng
        );

        if (mesafe > MAKS_MESAFE) {
            document.getElementById("info").textContent =
                `❌ Yetkisiz konum! Mesafe: ${mesafe.toFixed(1)} m`;
            return;
        }

        sorgula(); // ✅ sistem aktif

    }, () => {
        alert("Konum izni verilmedi");
    });
}

/* ---------------- SORGU ---------------- */
async function sorgula() {
    if (kilitli) return;
    kilitli = true;

    const btn = document.getElementById("btn");
    const info = document.getElementById("info");
    btn.disabled = true;

    let kalan = 20;
    btn.textContent = `Bekleyin (${kalan})`;

    const sayac = setInterval(() => {
        kalan--;
        btn.textContent = `Bekleyin (${kalan})`;
        if (kalan <= 0) {
            clearInterval(sayac);
            kilitli = false;
            btn.disabled = false;
            btn.textContent = "Sorgula";
        }
    }, 1000);

    info.textContent = "Sorgulanıyor...";

    const payload = {
        geoHash: HEDEF_GEOHASH,
        itemId: document.getElementById("itemId").value
    };

    const url =
        "https://rio.a101.com.tr/dbmk89vnr/CALL/StoreContentManager/nearestStores/default" +
        "?__culture=tr-TR&__platform=web&data=" +
        btoa(JSON.stringify(payload)) +
        "&__isbase64=true";

    try {
        const r = await fetch(url);
        const j = await r.json();

        const stores = (j.stores || []).sort((a,b)=>a.distance-b.distance);
        tablo(stores);
        info.textContent = `Toplam ${stores.length} mağaza`;

    } catch {
        info.textContent = "Hata oluştu";
    }
}

/* ---------------- TABLO ---------------- */
function tablo(stores) {
    if (!stores.length) return;

    let h = `<table><tr>
        <th>Mesafe</th><th>Mağaza</th><th>Adres</th><th>Stok</th>
    </tr>`;

    stores.forEach(s=>{
        let c="out", t=s.stockLevel;
        if(t==="sufficient"){c="sufficient";t="Yeterli"}
        else if(t==="limited"){c="limited";t="Sınırlı"}

        h+=`<tr>
            <td>${s.distance} m</td>
            <td>${s.name}</td>
            <td>${s.address}</td>
            <td class="${c}">${t}</td>
        </tr>`;
    });

    document.getElementById("tablo").innerHTML = h + "</table>";
}
</script>
</body>
</html>