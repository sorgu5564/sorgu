<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>A101 Lokal Stok Sorgu</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    font-family: Arial;
    background:#f4f4f4;
    margin:0;
    padding:20px
}
.box{
    max-width:900px;
    margin:auto;
    background:#fff;
    padding:20px;
    border-radius:8px;
    box-shadow:0 0 10px rgba(0,0,0,.1)
}
button{
    padding:10px 15px;
    font-size:16px;
    cursor:pointer
}
button:disabled{
    background:#ccc;
    cursor:not-allowed
}
input{
    padding:8px;
    font-size:16px;
    width:220px
}
.info{
    margin:10px 0;
    padding:10px;
    border-radius:4px
}
.ok{
    background:#e7f9ed;
    color:#1a7f37
}
.err{
    background:#fdecea;
    color:#b42318
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px
}
th,td{
    border:1px solid #ccc;
    padding:8px;
    text-align:left
}
th{
    background:#eee
}
</style>
</head>

<body>

<div class="box">
    <h2>A101 Stok Sorgulama</h2>

    <div id="konumUyari" class="info">
        Konum kontrol ediliyor...
    </div>

    <label>Item ID</label><br>
    <input id="itemId" value="30000905">
    <br><br>

    <button id="btn" onclick="sorgula()" disabled>
        Sorgula
    </button>

    <div id="sonuc"></div>
</div>

<script>
/******** AYARLAR ********/
const MERKEZ_LAT = 40.996;
const MERKEZ_LNG = 29.251;
const MAX_METRE  = 300;
const GEOHASH    = "sxkc1x5gj";
const SORGU_SURESI = 20000; // 20 saniye

let sonSorgu = 0;

/******** MESAFE HESABI ********/
function mesafeMetre(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a =
        Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2)**2;

    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/******** KONUM KONTROL ********/
function konumKontrol(){
    if(!navigator.geolocation){
        hata("Tarayıcı konum desteklemiyor");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        pos=>{
            const d = mesafeMetre(
                pos.coords.latitude,
                pos.coords.longitude,
                MERKEZ_LAT,
                MERKEZ_LNG
            );

            if(d <= MAX_METRE){
                bilgi(`Yetkili konum (${d.toFixed(1)} m)`);
                btn.disabled = false;
            }else{
                hata(`Yetkisiz konum (${d.toFixed(1)} m)`);
                btn.disabled = true;
            }
        },
        ()=>{
            hata("Konum izni verilmedi");
        },
        {
            enableHighAccuracy:true,
            timeout:10000,
            maximumAge:0
        }
    );
}

/******** SORGU ********/
async function sorgula(){
    const simdi = Date.now();

    if(simdi - sonSorgu < SORGU_SURESI){
        hata("20 saniye bekleyiniz");
        return;
    }

    sonSorgu = simdi;

    const itemId = document.getElementById("itemId").value.trim();
    if(!itemId){
        hata("Item ID boş");
        return;
    }

    bilgi("Sorgulanıyor...");

    const payload = btoa(JSON.stringify({
        geoHash: GEOHASH,
        itemId: itemId
    }));

    const url =
        "https://rio.a101.com.tr/dbmk89vnr/CALL/StoreContentManager/nearestStores/default" +
        "?__culture=tr-TR&__platform=web" +
        "&data=" + encodeURIComponent(payload) +
        "&__isbase64=true";

    try{
        const res = await fetch(url);
        const json = await res.json();
        tabloYap(json.stores || []);
    }catch(e){
        hata("Sorgu hatası");
    }
}

/******** TABLO ********/
function tabloYap(stores){
    if(stores.length === 0){
        hata("Sonuç yok");
        return;
    }

    stores.sort((a,b)=>a.distance - b.distance);

    let html =
        "<table>" +
        "<tr>" +
        "<th>ID</th>" +
        "<th>Mağaza</th>" +
        "<th>Adres</th>" +
        "<th>Mesafe (m)</th>" +
        "<th>Stok</th>" +
        "</tr>";

    stores.forEach(s=>{
        html +=
            `<tr>
                <td>${s.id}</td>
                <td>${s.name}</td>
                <td>${s.address}</td>
                <td>${s.distance}</td>
                <td>${s.stockLevel}</td>
            </tr>`;
    });

    html += "</table>";

    document.getElementById("sonuc").innerHTML = html;
}

/******** UI ********/
function bilgi(t){
    const u = document.getElementById("konumUyari");
    u.className = "info ok";
    u.textContent = t;
}
function hata(t){
    const u = document.getElementById("konumUyari");
    u.className = "info err";
    u.textContent = t;
}

/******** BAŞLAT ********/
konumKontrol();
</script>

</body>
</html>